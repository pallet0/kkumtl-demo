<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KKumtl - core</title>
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Mobile Responsive Styles -->
    <style>
        @media (max-width: 768px) {
            /* Reorder main content for mobile: header -> buttons -> editor -> parameters */
            .main-content {
                flex-direction: column;
                overflow-y: auto;
            }
            
            /* App container adjustments */
            #app-container {
                height: auto;
                min-height: 100vh;
                overflow-y: auto;
            }
            
            body {
                overflow-y: auto;
                height: auto;
            }
            
            /* Header - stays at top */
            .app-header {
                flex-wrap: wrap;
                height: auto;
                padding: 12px 16px;
                gap: 8px;
            }
            
            .header-left {
                width: 100%;
                justify-content: center;
            }
            
            .header-center {
                width: 100%;
                justify-content: center;
            }
            
            .header-right {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
                gap: 10px;
            }
            
            /* Mobile Generate Buttons - show prominently below header */
            .mobile-generate-buttons {
                display: flex !important;
                flex-direction: row;
                justify-content: center;
                gap: 12px;
                padding: 12px 16px;
                background: white;
                border-bottom: 1px solid var(--border-color);
                flex-wrap: wrap;
            }
            
            .mobile-generate-buttons .btn {
                flex: 1;
                min-width: 120px;
                max-width: 180px;
            }
            
            /* Hide toolbar center buttons on mobile (moved to mobile-generate-buttons) */
            .editor-toolbar .toolbar-center {
                display: none;
            }
            
            /* Simplify toolbar for mobile */
            .editor-toolbar {
                height: auto;
                padding: 8px 12px;
                justify-content: space-between;
            }
            
            .toolbar-left, .toolbar-right {
                gap: 4px;
            }
            
            /* Editor container - comes first after buttons */
            .editor-container {
                order: -1;
                min-height: 50vh;
            }
            
            .editor-wrapper {
                padding: 10px;
            }
            
            .editor-textarea {
                padding: 16px;
                font-size: 16px;
                min-height: 300px;
            }
            
            /* Sidebars - show as sections below editor */
            .sidebar {
                width: 100%;
                order: 2;
                border-right: none;
                border-left: none;
                border-top: 1px solid var(--border-color);
                max-height: none;
            }
            
            .sidebar-left {
                display: block !important;
                order: 2;
            }
            
            .sidebar-right {
                display: block !important;
                order: 3;
            }
            
            /* Make setting groups more compact on mobile */
            .sidebar-section {
                margin-bottom: 15px;
                padding-bottom: 15px;
            }
            
            .setting-group {
                margin-bottom: 12px;
            }
            
            /* Preset buttons - 2 columns on mobile */
            .preset-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            /* Editor footer adjustments */
            .editor-footer {
                flex-wrap: wrap;
                height: auto;
                padding: 8px 12px;
                gap: 8px;
            }
            
            .footer-left, .footer-center, .footer-right {
                width: 100%;
                text-align: center;
            }
        }
        
        /* Hide mobile generate buttons on desktop */
        .mobile-generate-buttons {
            display: none;
        }
        
        /* Small mobile adjustments */
        @media (max-width: 480px) {
            .app-title {
                font-size: 18px;
            }
            
            .app-subtitle {
                font-size: 11px;
            }
            
            .mobile-generate-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .mobile-generate-buttons .btn {
                width: 100%;
                max-width: 250px;
            }
            
            .survey-icons {
                display: none;
            }
        }
    </style>
    
    <!-- Google Fonts for novel-like typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Lora:ital,wght@0,400;0,500;0,600;1,400&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300;1,400&family=Noto+Sans+JP:wght@300;400;500&family=Noto+Sans+KR:wght@300;400;500&display=swap" rel="stylesheet">
</head>
<body>
    <!-- ========================================
         PASSWORD MODAL - For API Key Decryption
         ======================================== -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîê Enter Access Password</h2>
            </div>
            <div class="modal-body">
                <p>Please enter your password to unlock the AI writing features.</p>
                <input type="password" id="password-input" placeholder="Enter password..." autocomplete="off">
                <div id="password-error" class="error-message hidden"></div>
            </div>
            <div class="modal-footer">
                <button id="password-submit" class="btn btn-primary">Unlock</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         SURVEY MODAL - Feedback Collection
         ======================================== -->
    <div id="survey-modal" class="modal hidden">
        <div class="modal-content survey-modal-content">
            <div class="modal-header">
                <h2>üìù Share Your Feedback</h2>
                <button id="survey-close" class="modal-close-btn" aria-label="Close">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Satisfaction Question -->
                <div class="survey-question">
                    <label class="survey-label">Do you find this service satisfactory?</label>
                    <div class="survey-satisfaction">
                        <button id="survey-satisfactory" class="satisfaction-btn" data-value="satisfactory">
                            <span class="thumbs-icon large">üëç</span>
                            <span>Satisfactory</span>
                        </button>
                        <button id="survey-unsatisfactory" class="satisfaction-btn" data-value="unsatisfactory">
                            <span class="thumbs-icon large">üëé</span>
                            <span>Unsatisfactory</span>
                        </button>
                    </div>
                </div>

                <!-- Likes Reading Novels Question -->
                <div class="survey-question">
                    <label class="survey-label">Do you like reading novels/web novels/light novels?</label>
                    <div class="toggle-group survey-toggle">
                        <span class="toggle-label-text">No</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="survey-likes-novels">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label-text">Yes</span>
                    </div>
                </div>

                <!-- Email Question -->
                <div class="survey-question">
                    <label class="survey-label" for="survey-email">Your email (for follow-up)</label>
                    <input type="email" id="survey-email" class="survey-input" placeholder="your@email.com">
                </div>

                <!-- Suggestions Question -->
                <div class="survey-question">
                    <label class="survey-label" for="survey-suggestions">Any suggestions or feedback?</label>
                    <textarea id="survey-suggestions" class="survey-textarea" placeholder="Share your thoughts..." rows="4"></textarea>
                </div>

                <div id="survey-error" class="error-message hidden"></div>
            </div>
            <div class="modal-footer">
                <button id="survey-submit" class="btn btn-primary">Submit Feedback</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         MAIN APPLICATION CONTAINER
         ======================================== -->
    <div id="app-container" class="hidden">
        
        <!-- ========================================
             HEADER - Application Title & Status
             ======================================== -->
        <header class="app-header">
            <div class="header-left">
                <h1 class="app-title">üìñ ÍøàÌãÄ</h1>
                <span class="app-subtitle">ÏûêÏã†ÎßåÏùò ÏÜåÏÑ§ÏùÑ ÎßåÎì§Ïñ¥Í∞ÄÎ©∞</span>
                <!-- Survey Feedback Icons -->
                <div class="survey-icons">
                    <button id="survey-thumbs-up" class="survey-icon-btn" title="Like this service">
                        <span class="thumbs-icon">üëç</span>
                    </button>
                    <button id="survey-thumbs-down" class="survey-icon-btn" title="Dislike this service">
                        <span class="thumbs-icon">üëé</span>
                    </button>
                </div>
            </div>
            <div class="header-center">
                <!-- Generation Status Indicator -->
                <div id="status-indicator" class="status-idle">
                    <span class="status-dot"></span>
                    <span class="status-text">Ready</span>
                </div>
            </div>
            <div class="header-right">
                <!-- Remaining Generations Display -->
                <div id="remaining-generations" class="remaining-generations hidden">
                    <span id="remaining-count">0</span> generations left
                </div>
                <!-- Remaining Image Generations Display -->
                <div id="remaining-image-generations" class="remaining-image-generations hidden">
                    <span id="remaining-image-count">0</span> images left
                </div>
                <!-- Word Count Display -->
                <div class="word-count">
                    <span id="word-count">0</span> words
                </div>
                <!-- Character Count Display -->
                <div class="char-count">
                    <span id="char-count">0</span> chars
                </div>
            </div>
        </header>

        <!-- ========================================
             MOBILE GENERATE BUTTONS - Visible only on mobile
             ======================================== -->
        <div class="mobile-generate-buttons">
            <button id="btn-generate-mobile" class="btn btn-generate" title="Generate from cursor">
                ‚ú® Generate
            </button>
            <button id="btn-generate-image-mobile" class="btn btn-generate-image" title="Generate Image from context">
                üé® Image
            </button>
            <button id="btn-stop-mobile" class="btn btn-stop hidden" title="Stop Generation">
                ‚èπ Stop
            </button>
        </div>

        <!-- ========================================
             MAIN CONTENT AREA
             ======================================== -->
        <main class="main-content">
            
            <!-- ========================================
                 LEFT SIDEBAR - Generation Settings
                 ======================================== -->
            <aside class="sidebar sidebar-left">
                <div class="sidebar-section">
                    <h3 class="section-title">‚öôÔ∏è Generation Settings</h3>
                    
                    <!-- Model Selection -->
                    <div class="setting-group">
                        <label for="model-select">AI Model</label>
                        <select id="model-select" class="setting-input">
                            <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                            <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                            <option value="gemini-3-pro-preview">Gemini 3 Pro Preview</option>
                        </select>
                    </div>

                    <!-- Temperature Control -->
                    <div class="setting-group">
                        <label for="temperature-slider">
                            Temperature: <span id="temperature-value">0.8</span>
                        </label>
                        <input type="range" id="temperature-slider" class="setting-slider" 
                               min="0" max="2" step="0.1" value="0.8">
                        <div class="slider-labels">
                            <span>Focused</span>
                            <span>Creative</span>
                        </div>
                    </div>

                    <!-- Max Words Control -->
                    <div class="setting-group">
                        <label for="max-words-slider">
                            Max Words: <span id="max-words-value">150</span>
                        </label>
                        <input type="range" id="max-words-slider" class="setting-slider" 
                               min="50" max="500" step="25" value="150">
                        <div class="slider-labels">
                            <span>Short</span>
                            <span>Long</span>
                        </div>
                    </div>

                    <!-- Paragraph Length -->
                    <div class="setting-group">
                        <label for="paragraph-length">Paragraph Length</label>
                        <select id="paragraph-length" class="setting-input">
                            <option value="short">Short (2-3 sentences)</option>
                            <option value="medium" selected>Medium (4-6 sentences)</option>
                            <option value="long">Long (7+ sentences)</option>
                        </select>
                    </div>

                    <!-- Language Selection -->
                    <div class="setting-group">
                        <label for="language-select">Language</label>
                        <select id="language-select" class="setting-input">
                            <option value="EN" selected>English</option>
                            <option value="KR">ÌïúÍµ≠Ïñ¥ (Korean)</option>
                            <option value="JP">Êó•Êú¨Ë™û (Japanese)</option>
                        </select>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3 class="section-title">üìö Story Settings</h3>
                    
                    <!-- Genre Selection -->
                    <div class="setting-group">
                        <label for="genre-select">Genre</label>
                        <select id="genre-select" class="setting-input">
                            <option value="fantasy">Fantasy</option>
                            <option value="scifi">Science Fiction</option>
                            <option value="romance">Romance</option>
                            <option value="mystery">Mystery/Thriller</option>
                            <option value="horror">Horror</option>
                            <option value="literary">Literary Fiction</option>
                            <option value="adventure">Adventure</option>
                            <option value="historical">Historical Fiction</option>
                        </select>
                    </div>

                    <!-- Writing Style -->
                    <div class="setting-group">
                        <label for="style-select">Writing Style</label>
                        <select id="style-select" class="setting-input">
                            <option value="descriptive">Descriptive & Immersive</option>
                            <option value="concise">Concise & Direct</option>
                            <option value="poetic">Poetic & Lyrical</option>
                            <option value="dialogue-heavy">Dialogue Heavy</option>
                            <option value="action">Action-Oriented</option>
                            <option value="introspective">Introspective</option>
                        </select>
                    </div>

                    <!-- Tone Selection -->
                    <div class="setting-group">
                        <label for="tone-select">Tone</label>
                        <select id="tone-select" class="setting-input">
                            <option value="neutral">Neutral</option>
                            <option value="dark">Dark & Gritty</option>
                            <option value="light">Light & Hopeful</option>
                            <option value="humorous">Humorous</option>
                            <option value="dramatic">Dramatic</option>
                            <option value="mysterious">Mysterious</option>
                        </select>
                    </div>

                    <!-- POV Selection -->
                    <div class="setting-group">
                        <label for="pov-select">Point of View</label>
                        <select id="pov-select" class="setting-input">
                            <option value="third-limited">Third Person Limited</option>
                            <option value="third-omni">Third Person Omniscient</option>
                            <option value="first">First Person</option>
                            <option value="second">Second Person</option>
                        </select>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3 class="section-title"></h3>
                </div>
            </aside>

            <!-- ========================================
                 CENTER - Main Text Editor
                 ======================================== -->
            <div class="editor-container">
                <!-- Toolbar -->
                <div class="editor-toolbar">
                    <div class="toolbar-left">
                        <button id="btn-new" class="toolbar-btn toolbar-btn-compact" title="New Document">
                            üìÑ
                        </button>
                        <button id="btn-save" class="toolbar-btn toolbar-btn-compact" title="Save Document">
                            üíæ
                        </button>
                        <button id="btn-load" class="toolbar-btn toolbar-btn-compact" title="Load Document">
                            üìÇ
                        </button>
                        <div class="toolbar-separator"></div>
                        <button id="btn-undo" class="toolbar-btn toolbar-btn-compact" title="Undo (Ctrl+Z)">
                            ‚Ü∂
                        </button>
                        <button id="btn-redo" class="toolbar-btn toolbar-btn-compact" title="Redo (Ctrl+Y)">
                            ‚Ü∑
                        </button>
                    </div>
                    <div class="toolbar-center">
                        <!-- Generation Controls -->
                        <button id="btn-generate" class="btn btn-generate" title="Generate from cursor (Ctrl+Enter)">
                            ‚ú® Generate
                        </button>
                        <button id="btn-generate-image" class="btn btn-generate-image" title="Generate Image from context">
                            üé® Image
                        </button>
                        <button id="btn-stop" class="btn btn-stop hidden" title="Stop Generation (Escape)">
                            ‚èπ Stop
                        </button>
                    </div>
                    <div class="toolbar-right">
                        <button id="btn-fullscreen" class="toolbar-btn toolbar-btn-compact" title="Toggle Fullscreen">
                            ‚õ∂
                        </button>
                    </div>
                </div>

                <!-- Text Editor Area -->
                <div class="editor-wrapper">
                    <!-- Loading Overlay -->
                    <div id="loading-overlay" class="loading-overlay hidden">
                        <div class="spinner"></div>
                        <span class="loading-text">Generating...</span>
                    </div>

                    <!-- Main Text Area (contenteditable for real-time formatting) -->
                    <div id="editor-textarea" 
                         class="editor-textarea" 
                         contenteditable="true"
                         data-placeholder="Start writing your story here, or click Generate to let AI begin...

Tips:
- Place your cursor where you want AI to continue writing
- Use Ctrl+Enter to generate
- Press Escape to stop generation
- Your text is automatically saved"></div>
                </div>

                <!-- Editor Footer -->
                <div class="editor-footer">
                    <div class="footer-left">
                        <span id="cursor-position">Line 1, Column 1</span>
                    </div>
                    <div class="footer-center">
                        <span id="generation-info"></span>
                    </div>
                    <div class="footer-right">
                        <span id="autosave-status">Auto-saved</span>
                    </div>
                </div>
            </div>

            <!-- ========================================
                 RIGHT SIDEBAR - Formatting Options
                 ======================================== -->
            <aside class="sidebar sidebar-right">
                <div class="sidebar-section">
                    <h3 class="section-title">üé® Text Formatting</h3>
                    
                    <!-- Font Family -->
                    <div class="setting-group">
                        <label for="font-family">Font Family</label>
                        <select id="font-family" class="setting-input">
                            <option value="'Merriweather', serif">Merriweather</option>
                            <option value="'Lora', serif">Lora</option>
                            <option value="'Crimson Text', serif">Crimson Text</option>
                            <option value="'Georgia', serif">Georgia</option>
                            <option value="'Times New Roman', serif">Times New Roman</option>
                            <option value="'Noto Sans JP', sans-serif">Noto Sans JP</option>
                            <option value="'Noto Sans KR', sans-serif">Noto Sans KR</option>
                        </select>
                    </div>

                    <!-- Font Size -->
                    <div class="setting-group">
                        <label for="font-size-slider">
                            Font Size: <span id="font-size-value">18</span>px
                        </label>
                        <input type="range" id="font-size-slider" class="setting-slider" 
                               min="12" max="28" step="1" value="18">
                    </div>

                    <!-- Line Height -->
                    <div class="setting-group">
                        <label for="line-height-slider">
                            Line Height: <span id="line-height-value">1.8</span>
                        </label>
                        <input type="range" id="line-height-slider" class="setting-slider" 
                               min="1.2" max="2.5" step="0.1" value="1.8">
                    </div>

                    <!-- Paragraph Spacing -->
                    <div class="setting-group">
                        <label for="paragraph-spacing-slider">
                            Paragraph Spacing: <span id="paragraph-spacing-value">1.5</span>em
                        </label>
                        <input type="range" id="paragraph-spacing-slider" class="setting-slider" 
                               min="0.5" max="3" step="0.25" value="1.5">
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3 class="section-title">üåà Highlight Colors</h3>
                    
                    <!-- Dialogue Color (Double Quotes) -->
                    <div class="setting-group color-group">
                        <label for="dialogue-color">
                            Dialogue ("...") Color
                        </label>
                        <div class="color-picker-wrapper">
                            <input type="color" id="dialogue-color" class="color-picker" value="#e67e22">
                            <span class="color-preview" style="background-color: #e67e22;"></span>
                        </div>
                    </div>

                    <!-- Thoughts Color (Single Quotes) -->
                    <div class="setting-group color-group">
                        <label for="thoughts-color">
                            Thoughts ('...') Color
                        </label>
                        <div class="color-picker-wrapper">
                            <input type="color" id="thoughts-color" class="color-picker" value="#3498db">
                            <span class="color-preview" style="background-color: #3498db;"></span>
                        </div>
                    </div>

                    <!-- Emphasis Color -->
                    <div class="setting-group color-group">
                        <label for="emphasis-color">
                            Emphasis (*...*) Color
                        </label>
                        <div class="color-picker-wrapper">
                            <input type="color" id="emphasis-color" class="color-picker" value="#9b59b6">
                            <span class="color-preview" style="background-color: #9b59b6;"></span>
                        </div>
                    </div>

                    <!-- Text Color -->
                    <div class="setting-group color-group">
                        <label for="text-color">
                            Base Text Color
                        </label>
                        <div class="color-picker-wrapper">
                            <input type="color" id="text-color" class="color-picker" value="#2c3e50">
                            <span class="color-preview" style="background-color: #2c3e50;"></span>
                        </div>
                    </div>

                    <!-- Background Color -->
                    <div class="setting-group color-group">
                        <label for="bg-color">
                            Background Color
                        </label>
                        <div class="color-picker-wrapper">
                            <input type="color" id="bg-color" class="color-picker" value="#fdf6e3">
                            <span class="color-preview" style="background-color: #fdf6e3;"></span>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3 class="section-title">üìã Presets</h3>
                    
                    <!-- Theme Presets -->
                    <div class="preset-buttons">
                        <button class="preset-btn" data-preset="sepia">üìú Sepia</button>
                        <button class="preset-btn" data-preset="dark">üåô Dark</button>
                        <button class="preset-btn" data-preset="light">‚òÄÔ∏è Light</button>
                        <button class="preset-btn" data-preset="paper">üìÑ Paper</button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3 class="section-title">üíæ Actions</h3>
                    <div class="action-buttons">
                        <button id="btn-export-txt" class="action-btn">Export as .txt</button>
                        <button id="btn-export-html" class="action-btn">Export as .html</button>
                        <button id="btn-reset-settings" class="action-btn">Reset Settings</button>
                    </div>
                </div>
            </aside>
        </main>

        <!-- ========================================
             ALERT CONTAINER - For Error Messages
             ======================================== -->
        <div id="alert-container" class="alert-container"></div>
    </div>

    <!-- ========================================
         HIDDEN FILE INPUT FOR LOADING
         ======================================== -->
    <input type="file" id="file-input" accept=".txt,.json" style="display: none;">

    <!-- ========================================
         SCRIPTS
         ======================================== -->
    <script src="js/crypto.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/formatter.js"></script>
    <script src="js/ratelimit.js"></script>
    <script src="js/gemini.js"></script>
    <script src="js/app.js"></script>
    <script src="js/survey.js"></script>
    
    <!-- Mobile Button Synchronization Script -->
    <script>
        (function() {
            'use strict';
            
            // Wait for DOM to be ready
            document.addEventListener('DOMContentLoaded', function() {
                // Get references to desktop and mobile buttons
                const btnGenerate = document.getElementById('btn-generate');
                const btnGenerateImage = document.getElementById('btn-generate-image');
                const btnStop = document.getElementById('btn-stop');
                
                const btnGenerateMobile = document.getElementById('btn-generate-mobile');
                const btnGenerateImageMobile = document.getElementById('btn-generate-image-mobile');
                const btnStopMobile = document.getElementById('btn-stop-mobile');
                
                // Sync mobile buttons with desktop buttons
                if (btnGenerateMobile && btnGenerate) {
                    btnGenerateMobile.addEventListener('click', function() {
                        btnGenerate.click();
                    });
                }
                
                if (btnGenerateImageMobile && btnGenerateImage) {
                    btnGenerateImageMobile.addEventListener('click', function() {
                        btnGenerateImage.click();
                    });
                }
                
                if (btnStopMobile && btnStop) {
                    btnStopMobile.addEventListener('click', function() {
                        btnStop.click();
                    });
                }
                
                // Observe class changes on desktop buttons to sync visibility with mobile
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.attributeName === 'class') {
                            const target = mutation.target;
                            
                            // Sync Generate button visibility
                            if (target === btnGenerate && btnGenerateMobile) {
                                btnGenerateMobile.className = target.className;
                            }
                            
                            // Sync Generate Image button visibility
                            if (target === btnGenerateImage && btnGenerateImageMobile) {
                                btnGenerateImageMobile.className = target.className;
                            }
                            
                            // Sync Stop button visibility
                            if (target === btnStop && btnStopMobile) {
                                btnStopMobile.className = target.className;
                            }
                        }
                    });
                });
                
                // Start observing desktop buttons for class changes
                const observerConfig = { attributes: true, attributeFilter: ['class'] };
                
                if (btnGenerate) observer.observe(btnGenerate, observerConfig);
                if (btnGenerateImage) observer.observe(btnGenerateImage, observerConfig);
                if (btnStop) observer.observe(btnStop, observerConfig);
            });
        })();
    </script>
</body>
</html>